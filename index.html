<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="chat">
    <meta name="keywords" content="get x">
    <meta name="author" content="chat test">
    <title>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ CSS -->
    <link rel="stylesheet" href="styles.css">
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ —Å–∞–π—Ç–∞ (favicon) -->
<!--    <link rel="icon" href="favicon.ico" type="image/x-icon">-->

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 80vh;
        }
    </style>

</head>
<body>

<header>
<!--    <h1>Chat x</h1>-->






</header>

<body>
<!--<p id="coordinates">–ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã...</p>-->
<!--<p id="location">–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...</p>-->


<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
<div id="fake-coordinates">Generating random Dunstable coordinates...</div>
<div id="fake-location">Converting coordinates to location...</div>
<!--<p><a id="map-link" target="_blank" rel="noopener">View on OpenStreetMap</a></p>-->

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã -->
<div id="map" style="height: 400px; width: 100%; margin-top: 20px;"></div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let randomLat = null;
    let randomLng = null;
    let randomAdr = null;

    // –ì—Ä–∞–Ω–∏—Ü—ã Dunstable
    const DUNSTABLE = {
        latMin: 51.880,
        latMax: 51.900,
        lonMin: -0.535,
        lonMax: -0.505
    };

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π —Ç–æ—á–∫–∏
    function getRandomLocation() {
        return {
            lat: DUNSTABLE.latMin + Math.random() * (DUNSTABLE.latMax - DUNSTABLE.latMin),
            lng: DUNSTABLE.lonMin + Math.random() * (DUNSTABLE.lonMax - DUNSTABLE.lonMin)
        };
    }

    // –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
    function fetchAddress(lat, lng) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;

        fetch(url, {
            headers: {
                'User-Agent': 'RandomDunstableMap/1.0'
            }
        })
            .then(response => response.json())
            .then(data => {
                randomAdr = data.display_name || "Address not found";
                console.log("–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å:", randomAdr);

                // –í—Å—Ç–∞–≤–ª—è–µ–º –∞–¥—Ä–µ—Å –≤ #fake-location
                document.getElementById("fake-location").textContent = `Location: ${randomAdr}`;
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–¥—Ä–µ—Å–∞:", error);
                document.getElementById("fake-location").textContent = "Failed to get address.";
            });
    }


    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∏ –º–∞—Ä–∫–µ—Ä–∞
    function initMap() {
        const map = L.map('map').setView([51.886, -0.522], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const randomLoc = getRandomLocation();
        randomLat = randomLoc.lat;
        randomLng = randomLoc.lng;

        L.marker([randomLat, randomLng])
            .addTo(map)
            .bindPopup("Random location in Dunstable")
            .openPopup();

        map.setView([randomLat, randomLng], 13);

        document.getElementById("fake-coordinates").textContent =
            `Random Dunstable point: ${randomLat.toFixed(6)}, ${randomLng.toFixed(6)}`;

        // document.getElementById("map-link").href =
        //     `https://www.openstreetmap.org/?mlat=${randomLat}&mlon=${randomLng}&zoom=15`;

        // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å
        fetchAddress(randomLat, randomLng);
    }

    window.addEventListener('DOMContentLoaded', initMap);
</script>


<!--<script>-->
<!--    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-->
<!--    let randomLat = null;-->
<!--    let randomLng = null;-->

<!--    // –ì—Ä–∞–Ω–∏—Ü—ã Dunstable-->
<!--    const DUNSTABLE = {-->
<!--        latMin: 51.880,-->
<!--        latMax: 51.900,-->
<!--        lonMin: -0.535,-->
<!--        lonMax: -0.505-->
<!--    };-->

<!--    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π —Ç–æ—á–∫–∏-->
<!--    function getRandomLocation() {-->
<!--        return {-->
<!--            lat: DUNSTABLE.latMin + Math.random() * (DUNSTABLE.latMax - DUNSTABLE.latMin),-->
<!--            lng: DUNSTABLE.lonMin + Math.random() * (DUNSTABLE.lonMax - DUNSTABLE.lonMin)-->
<!--        };-->
<!--    }-->

<!--    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∏ –º–∞—Ä–∫–µ—Ä–∞-->
<!--    function initMap() {-->
<!--        const map = L.map('map').setView([51.886, -0.522], 13);-->

<!--        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {-->
<!--            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'-->
<!--        }).addTo(map);-->

<!--        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ç–æ—á–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-->
<!--        const randomLoc = getRandomLocation();-->
<!--        randomLat = randomLoc.lat;-->
<!--        randomLng = randomLoc.lng;-->

<!--        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä-->
<!--        const marker = L.marker([randomLat, randomLng])-->
<!--            .addTo(map)-->
<!--            .bindPopup("Random location in Dunstable")-->
<!--            .openPopup();-->

<!--        map.setView([randomLat, randomLng], 13);-->

<!--        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∏ —Å—Å—ã–ª–∫—É-->
<!--        document.getElementById("fake-coordinates").textContent =-->
<!--            `Random Dunstable point: ${randomLat.toFixed(6)}, ${randomLng.toFixed(6)}`;-->

<!--        document.getElementById("map-link").href =-->
<!--            `https://www.openstreetmap.org/?mlat=${randomLat}&mlon=${randomLng}&zoom=15`;-->
<!--    }-->

<!--    window.addEventListener('DOMContentLoaded', initMap);-->
<!--</script>-->





















<!-- –ú–µ—Å—Ç–æ –¥–ª—è –∫–∞—Ä—Ç—ã -->
<!--<div id="map" style="width: 800px; height: 500px; border: 1px solid #ccc;"></div>-->
<!--<div id="map"></div>-->

<!--&lt;!&ndash; –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç Leaflet &ndash;&gt;-->
<!--<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>-->

<!--&lt;!&ndash; –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã &ndash;&gt;-->
<!--<script>-->
<!--    const map = L.map('map').setView([51.886102427616734, -0.5216997222963081], 13);-->

<!--    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {-->
<!--        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'-->
<!--    }).addTo(map);-->

<!--    L.marker([51.886102427616734, -0.5216997222963081])-->
<!--        .addTo(map)-->
<!--        .bindPopup("Dunstable");-->
<!--</script>-->

<!--google map-->
<!--<div id="map" style="width:100%; height:350px; margin-top:20px; border:1px solid #ddd;">-->
<!--    –ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...-->
<!--</div>-->

<script>
    window.onload = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // –í—ã–≤–æ–¥–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    document.getElementById("coordinates").innerHTML =
                        `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –®–∏—Ä–æ—Ç–∞ ${lat}, –î–æ–ª–≥–æ—Ç–∞ ${lon}`;

                    // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç—É Google Maps
                    // const iframe = document.createElement('iframe');
                    // iframe.setAttribute('src',
                    //     `https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d10000!2d${lon}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1sen!2sru!4v${Date.now()}!5m2!1sen!2sru`
                    // );
                    // iframe.setAttribute('width', '100%');
                    // iframe.setAttribute('height', '350');
                    // iframe.setAttribute('style', 'border:0;');
                    // iframe.setAttribute('allowfullscreen', '');
                    // iframe.setAttribute('loading', 'lazy');
                    //
                    // document.getElementById('map').innerHTML = '';
                    // document.getElementById('map').appendChild(iframe);

                    // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
                        );
                        const data = await response.json();
                        const address = data.address;
                        let locationInfo = "";

                        if (address.city || address.town || address.village) {
                            locationInfo += address.city || address.town || address.village;
                        }
                        if (address.country) {
                            locationInfo += `, ${address.country}`;
                        }

                        if (data.display_name) {
                            locationInfo = data.display_name;
                        }

                        document.getElementById("location").innerHTML =
                            `–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: <strong>${locationInfo}</strong>`;
                    } catch (error) {
                        document.getElementById("location").innerHTML =
                            "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å";
                    }
                },
                function(error) {
                    document.getElementById("coordinates").innerHTML =
                        "–û—à–∏–±–∫–∞: " + error.message;
                }
            );
        } else {
            document.getElementById("coordinates").innerHTML =
                "–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é";
        }
    };
</script>


<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<main>

</main>

<!-- –ü–æ–¥–≤–∞–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<footer>
<!--    <p>&copy;2025</p>-->
</footer>

<!-- —á–∞—Ç -->
<link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
<style>
    :root {
        --chat--color-primary: #33aa1e;
        --chat--color-primary-shade-50: #33aa1e;
        --chat--color-primary-shade-100: #33aa1e;
        --chat--color-secondary: #2b5177;
        --chat--color-secondary-shade-50: #1ca08a;
        --chat--color-white: #ffffff;
        --chat--color-light: #f2f4f8;
        --chat--color-light-shade-50: #e6e9f1;
        --chat--color-light-shade-100: #c2c5cc;
        --chat--color-medium: #d2d4d9;
        --chat--color-dark: #636363;
        --chat--color-disabled: #777980;
        --chat--color-typing: #404040;

        --chat--spacing: 0.8rem;
        /*--chat--spacing: 1rem;*/
        --chat--border-radius: 0.5rem;
        /*--chat--border-radius: 0.25rem;*/
        --chat--transition-duration: 0.15s;
        --chat--window--width: 400px;
        --chat--window--height: 600px;
        --chat--header-height: 20px;
        /*--chat--header-height: auto;*/

        --chat--color-bot-text: #ffffff;
        --chat--color-bot-background: #182533;
        --chat--header--padding: var(--chat--spacing);
        --chat--header--background: var(--chat--color-dark);
        --chat--header--color: var(--chat--color-light);
        --chat--header--border-top: none;
        --chat--header--border-bottom: none;
        --chat--heading--font-size: 1.5em;
        --chat--subtitle--font-size: inherit;
        --chat--subtitle--line-height: 1.8;
        --chat--textarea--height: 50px;
        --chat--message--font-size: 1rem;
        --chat--message--padding: var(--chat--spacing);
        --chat--message--border-radius: var(--chat--border-radius);
        --chat--message-line-height: 1.5;
        /*--chat--message-line-height: 1.8;*/
        --chat--message--bot--background: var(--chat--color-dark);
        --chat--message--bot--color: var(--chat--color-bot-text);
        --chat--message--bot--border: none;
        --chat--message--user--background: var(--chat--color-secondary);
        --chat--message--user--color: var(--chat--color-white);
        --chat--message--user--border: none;
        --chat--message--pre--background: rgba(0, 0, 0, 0.05);
        --chat--toggle--background: var(--chat--color-primary);
        --chat--toggle--hover--background: var(--chat--color-primary-shade-50);
        --chat--toggle--active--background: var(--chat--color-primary-shade-100);
        --chat--toggle--color: var(--chat--color-white);
        --chat--toggle--size: 100px;
    }
</style>



<!--without message print-->
<!--<script type="module">-->
<!--    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';-->

<!--    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é-->
<!--    navigator.geolocation.getCurrentPosition(-->
<!--        async (position) => {-->
<!--            const lat = position.coords.latitude;-->
<!--            const lon = position.coords.longitude;-->

<!--            // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å —á–µ—Ä–µ–∑ Nominatim-->
<!--            try {-->
<!--                const response = await fetch(-->
<!--                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`-->
<!--                );-->
<!--                const data = await response.json();-->
<!--                const address = data.display_name || 'Unknown location';-->

<!--                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Ç —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏-->
<!--                initChat(address, lat, lon);-->
<!--            } catch (error) {-->
<!--                console.error('Geocoding error:', error);-->
<!--                initChat(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏-->
<!--            }-->
<!--        },-->
<!--        (error) => {-->
<!--            console.error('Geolocation error:', error);-->
<!--            initChat(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏-->
<!--        }-->
<!--    );-->

<!--    function initChat(address = null, lat = null, lon = null) {-->
<!--        createChat({-->
<!--            webhookUrl: 'https://ntimer.com/webhook/df19d314-9eae-4992-ad8a-df56fc35ca63/chat',-->
<!--            webhookConfig: {-->
<!--                method: 'POST',-->
<!--                headers: { }-->
<!--            },-->
<!--            target: '#n8n-chat',-->
<!--            mode: 'window',-->
<!--            chatInputKey: 'chatInput',-->
<!--            chatSessionKey: 'sessionId',-->
<!--            metadata: {-->
<!--                location: address,-->
<!--                coordinates: lat && lon ? `${lat},${lon}` : null-->
<!--            },-->
<!--            showWelcomeScreen: false,-->
<!--            defaultLanguage: 'en',-->
<!--            initialMessages: [-->
<!--                // 'Hi! üëã',-->
<!--                address ? `I see you're near ${address}` : 'Address not found'-->
<!--            ],-->
<!--            i18n: {-->
<!--                en: {-->
<!--                    title: 'Hello! üëã',-->
<!--                    subtitle: "",-->
<!--                    footer: '',-->
<!--                    getStarted: 'new conversation',-->
<!--                    inputPlaceholder: 'input your request..',-->
<!--                },-->
<!--            },-->

<!--        });-->


<!--    }-->
<!--</script>-->



<!--without message originator-->
<!--correct ver -->
<!--<script type="module">-->
<!--    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';-->

<!--    // === –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π ===-->
<!--    function observeChatMessages() {-->
<!--        const observer = new MutationObserver((mutationsList) => {-->
<!--            for (const mutation of mutationsList) {-->
<!--                if (mutation.type === 'childList') {-->
<!--                    mutation.addedNodes.forEach((node) => {-->
<!--                        if (node.nodeType === 1) {-->
<!--                            const text = node.textContent.trim();-->
<!--                            if (text) {-->
<!--                                console.log('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ:', text);-->
<!--                            }-->
<!--                        }-->
<!--                    });-->
<!--                }-->
<!--            }-->
<!--        });-->

<!--        // –ü–æ–¥–æ–∂–¥–µ–º, –ø–æ–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞-->
<!--        const checkInterval = setInterval(() => {-->
<!--            const chatContainer = document.querySelector('#n8n-chat');-->
<!--            if (chatContainer) {-->
<!--                observer.observe(chatContainer, {-->
<!--                    childList: true,-->
<!--                    subtree: true,-->
<!--                });-->
<!--                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —á–∞—Ç–∞');-->
<!--                clearInterval(checkInterval);-->
<!--            }-->
<!--        }, 500);-->
<!--    }-->

<!--    // === –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è + –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ ===-->
<!--    navigator.geolocation.getCurrentPosition(-->
<!--        async (position) => {-->
<!--            const lat = position.coords.latitude;-->
<!--            const lon = position.coords.longitude;-->

<!--            try {-->
<!--                const response = await fetch(-->
<!--                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`-->
<!--                );-->
<!--                const data = await response.json();-->
<!--                const address = data.display_name || 'Unknown location';-->

<!--                initChat(address, lat, lon);-->
<!--            } catch (error) {-->
<!--                console.error('Geocoding error:', error);-->
<!--                initChat();-->
<!--            }-->
<!--        },-->
<!--        (error) => {-->
<!--            console.error('Geolocation error:', error);-->
<!--            initChat();-->
<!--        }-->
<!--    );-->

<!--    function initChat(address = null, lat = null, lon = null) {-->
<!--        createChat({-->
<!--            webhookUrl: 'https://ntimer.com/webhook/df19d314-9eae-4992-ad8a-df56fc35ca63/chat',-->
<!--            webhookConfig: {-->
<!--                method: 'POST',-->
<!--                headers: {},-->
<!--            },-->
<!--            target: '#n8n-chat',-->
<!--            mode: 'window',-->
<!--            chatInputKey: 'chatInput',-->
<!--            chatSessionKey: 'sessionId',-->
<!--            metadata: {-->
<!--                location: address,-->
<!--                coordinates: lat && lon ? `${lat},${lon}` : null,-->
<!--            },-->
<!--            showWelcomeScreen: false,-->
<!--            defaultLanguage: 'en',-->
<!--            initialMessages: [-->
<!--                address ? `I see you're near ${address}` : 'Address not found',-->
<!--            ],-->
<!--            i18n: {-->
<!--                en: {-->
<!--                    title: 'Hello! üëã',-->
<!--                    subtitle: '',-->
<!--                    footer: '',-->
<!--                    getStarted: 'new conversation',-->
<!--                    inputPlaceholder: 'input your request..',-->
<!--                },-->
<!--            },-->
<!--        });-->

<!--        // –í–ê–ñ–ù–û: –∑–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞-->
<!--        observeChatMessages();-->
<!--    }-->
<!--</script>-->
<!--correct ver-->











<script type="module">
    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

    // === –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π ===
    function observeChatMessages() {
        const observer = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) {
                            const text = node.textContent.trim();
                            if (text) {
                                const role = detectMessageRole(node);
                                console.log(`[${role}] ${text}`);
                            }
                        }
                    });
                }
            }
        });

        const checkInterval = setInterval(() => {
            const chatContainer = document.querySelector('#n8n-chat');
            if (chatContainer) {
                observer.observe(chatContainer, {
                    childList: true,
                    subtree: true,
                });
                console.log('‚úÖ Chat observer connected');
                clearInterval(checkInterval);
            }
        }, 500);
    }

    // üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –∫—Ç–æ –∞–≤—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
    function detectMessageRole(node) {
        const html = node.outerHTML;

        if (html.includes('chat-message chat-message-from-user')) {
        // if (html.includes('n8n-chat-message-user')) {
            return 'user';
        }
        if (html.includes('chat-message chat-message-from-bot')) {
        // if (html.includes('n8n-chat-message-bot')) {
            return 'bot';
        }

        // –ü—Ä–æ–±—É–µ–º –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å–æ–æ–±—â–µ–Ω–∏—è (–ø—Ä–∞–≤–æ = –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
        // const parent = node.closest('[class*="justify-end"], [class*="justify-start"]');
        // if (parent?.classList.contains('justify-end')) return 'user';
        // if (parent?.classList.contains('justify-start')) return 'bot';

        return 'unknown';
    }



    // === –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è + –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ ===
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
                );
                const data = await response.json();
                const address = data.display_name || 'Unknown location';

                initChat(address, lat, lon);
            } catch (error) {
                console.error('Geocoding error:', error);
                initChat();
            }
        },
        (error) => {
            console.error('Geolocation error:', error);
            initChat();
        }
    );

    function initChat(address = null, lat = null, lon = null) {
        createChat({
            webhookUrl: 'https://ntimer.com/webhook/df19d314-9eae-4992-ad8a-df56fc35ca63/chat',
            webhookConfig: {
                method: 'POST',
                headers: {},
            },
            target: '#n8n-chat',
            mode: 'window',
            chatInputKey: 'chatInput',
            chatSessionKey: 'sessionId',
            metadata: {
                // location: address,
                location: randomAdr,
                coordinates: randomLat && randomLng ? `${randomLat},${randomLng}` : null,
                // coordinates: lat && lon ? `${lat},${lon}` : null,
            },
            showWelcomeScreen: false,
            defaultLanguage: 'en',
            initialMessages: [
                // 'Hi!',
                address ? `I see you're near ${randomAdr}` : 'Address not found',
                // address ? `I see you're near ${address}` : 'Address not found',
            ],
            i18n: {
                en: {
                    title: 'Hello! üëã',
                    subtitle: '',
                    footer: '',
                    getStarted: 'new conversation',
                    inputPlaceholder: 'input your request..',
                },
            },
        });

        // –í–ê–ñ–ù–û: –∑–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞
        observeChatMessages();
    }
</script>




</body>
</html>